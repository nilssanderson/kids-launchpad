<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kids Learning Launchpad ‚Äî Monday</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 16px; background: #fafafa; color: #222; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .stat { font-size: 18px; margin-right: 12px; }
    #tiles { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 8px; }
    .tile { display: block; text-decoration: none; background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); color: #111; border: 2px solid transparent; }
    .tile:active { transform: scale(0.99); }
    .tile:hover { border-color: #e0e7ff; }
    .tile h3 { margin: 0 0 6px; font-size: 18px; }
    .tile p { margin: 0; color: #555; font-size: 14px; }
    .controls { display: flex; gap: 10px; align-items: center; margin-top: 12px; flex-wrap: wrap; }
    button { background: #2563eb; color: white; border: 0; border-radius: 8px; padding: 10px 14px; font-size: 14px; }
    button.secondary { background: #6b7280; }
    select { padding: 8px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #d1d5db; }
    .row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .stars { font-size: 22px; letter-spacing: 2px; }
    .note { font-size: 12px; color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <strong>Monday</strong>
      <span id="status" class="note">Online?</span>
    </div>
    <div class="row">
      <div class="stat">Stars: <span id="stars" class="stars">‚Äî</span></div>
      <div class="stat" id="streak">Streak: ‚Äî</div>
      <select id="childSelect" aria-label="Choose Child">
        <option value="p2" selected>P2 (5‚Äì6y)</option>
        <option value="pq">Pre-P1 (4‚Äì5y)</option>
      </select>
    </div>
  </header>

  <div id="tiles"></div>

  <div class="controls">
    <button onclick="awardDone('manual')">Give Star (Manual Test)</button>
    <button class="secondary" onclick="refreshTotals()">Refresh Totals</button>
    <button class="secondary" onclick="healthCheck()">Health Check</button>
  </div>

  <p class="note">Tip: Open a tile, play for 4+ minutes, then return to this tab to auto-award a star. Or use ‚ÄúGive Star‚Äù.</p>

  <script>
    // ====== Your Apps Script Web App URL and token ======
    const API_URL = 'https://script.google.com/macros/s/AKfycbxbY-QOLnByjaoSVaSJ0ASPSh2T0IQCMIuZcP08V51Kp3EoIT_KWf-r5zf4ljOW8PU9sA/exec';
    const API_TOKEN = 'b4e7b3f6f0c24b0f8b3df4a2a0c7e9d1a6c3e2f9b7d48a0c5f1e4a7c9b2d6f0'; // Must match Script Properties: API_TOKEN

    // ====== Child selection ======
    const childSelectEl = document.getElementById('childSelect');
    function activeChildId(){ return childSelectEl.value; }

    // ====== Monday tiles (direct activity links) ======
    const MONDAY_TILES = {
      p2: [
        {
          id: 'karate_cats_maths',
          label: 'Karate Cats: Maths',
          emoji: 'ü•ã',
          url: 'https://www.bbc.co.uk/bitesize/topics/zjkphbk/articles/zf4sscw',
          blurb: 'Number, addition and subtraction practice.'
        },
        {
          id: 'space_shoppers',
          label: 'Space Shoppers: Money Funfair',
          emoji: 'üéüÔ∏è',
          url: 'https://www.bbc.co.uk/bitesize/topics/zp8hvcw/articles/zvspwty',
          blurb: 'Coins and money skills.'
        },
        {
          id: 'buds_number_garden',
          label: 'Bud‚Äôs Number Garden',
          emoji: 'üåº',
          url: 'https://www.bbc.co.uk/games/embed/bud?sport=full',
          blurb: 'Counting and number order.'
        }
      ],
      pq: [
        {
          id: 'buds_number_garden',
          label: 'Bud‚Äôs Number Garden',
          emoji: 'üåº',
          url: 'https://www.bbc.co.uk/games/embed/bud?sport=full',
          blurb: 'Gentle counting practice.'
        },
        {
          id: 'space_shoppers',
          label: 'Space Shoppers: Money Funfair',
          emoji: 'üéüÔ∏è',
          url: 'https://www.bbc.co.uk/bitesize/topics/zp8hvcw/articles/zvspwty',
          blurb: 'Recognise coins, match values.'
        },
        {
          id: 'karate_cats_maths',
          label: 'Karate Cats: Maths',
          emoji: 'ü•ã',
          url: 'https://www.bbc.co.uk/bitesize/topics/zjkphbk/articles/zf4sscw',
          blurb: 'Short challenges with medals.'
        }
      ]
    };

    // ====== Device ID ======
    function deviceId(){
      let id = localStorage.getItem('device_id');
      if(!id){
        id = (crypto.randomUUID?.() || Math.random().toString(36).slice(2)) + '-fire';
        localStorage.setItem('device_id', id);
      }
      return id;
    }

    // ====== Status/Stars UI ======
    function setStatus(text, isError=false){
      const el = document.getElementById('status');
      el.textContent = text;
      el.style.color = isError ? '#b91c1c' : '#6b7280';
    }

    function renderStars(stars, streak){
      const el = document.getElementById('stars');
      const st = document.getElementById('streak');
      el.textContent = stars > 0 ? '‚≠ê'.repeat(Math.min(stars, 20)) : '‚Äî';
      st.textContent = `Streak: ${streak || 0} days`;
    }

    // ====== CORS-safe API helpers ======
    async function apiGet(params){
      const q = new URLSearchParams({...params, token: API_TOKEN});
      try {
        const res = await fetch(`${API_URL}?${q.toString()}`); // no custom headers => simple GET
        const json = await res.json();
        return json;
      } catch (e){
        setStatus('Offline', true);
        return {error:'network'};
      }
    }

    async function apiPost(path, body){
      // Put token in query; send body as text/plain to avoid preflight
      const url = `${API_URL}?path=${encodeURIComponent(path)}&token=${encodeURIComponent(API_TOKEN)}`;
      try {
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // simple request => no preflight
          body: JSON.stringify(body)
        });
        let json;
        try { json = await res.json(); }
        catch { json = { ok: res.ok }; }
        return json;
      } catch (e){
        setStatus('Offline', true);
        return {error:'network'};
      }
    }

    // ====== Health check ======
    async function healthCheck(){
      const data = await apiGet({ path:'health' });
      if (data && data.ok){
        setStatus('Online');
        alert('Health OK: ' + data.now);
      } else {
        setStatus('Unauthorized?', true);
        alert('Health failed. If you see {"error":"unauthorized"}, check Script Properties API_TOKEN and redeploy the web app.');
      }
    }

    // ====== Totals (server authority) ======
    async function refreshTotals(){
      const data = await apiGet({ path:'totals/get', child_id: activeChildId(), date: new Date().toISOString().slice(0,10) });
      if (data && !data.error){
        renderStars(Number(data.stars||0), Number(data.streak_days||0));
        setStatus('Online');
      } else if (data && data.error === 'unauthorized'){
        setStatus('Unauthorized', true);
      } else {
        setStatus('Offline', true);
      }
    }

    // ====== Tiles ======
    function hydrateTiles(){
      const tiles = MONDAY_TILES[activeChildId()] || [];
      const container = document.getElementById('tiles');
      container.innerHTML = '';
      tiles.forEach(t=>{
        const a = document.createElement('a');
        a.href = t.url;
        a.className = 'tile';
        a.target = '_blank';
        a.rel = 'noopener';
        a.innerHTML = `<h3>${t.emoji || ''} ${t.label}</h3><p>${t.blurb || ''}</p>`;
        a.addEventListener('click', ()=> recordLaunch(t.id));
        container.appendChild(a);
      });
    }

    // ====== Event logging / award ======
    let lastLaunch = null;

    function recordLaunch(tileId){
      lastLaunch = { tileId, start: new Date().toISOString() };
    }

    async function awardDone(method='done'){
      if (!lastLaunch) return;
      const ev = {
        device_id: deviceId(),
        child_id: activeChildId(),
        tile_id: lastLaunch.tileId,
        page: 'monday',
        action: 'done_award',
        start_ts: lastLaunch.start,
        end_ts: new Date().toISOString(),
        duration_s: Math.max(0, Math.floor((Date.now() - Date.parse(lastLaunch.start))/1000)),
        method,
        client_version: 'mon-1.0.0'
      };
      const res = await apiPost('events/create', ev);
      if (res && res.ok){
        lastLaunch = null;
        await refreshTotals();
      } else if (res && res.error === 'unauthorized'){
        setStatus('Unauthorized', true);
        alert('Unauthorized: Ensure your Apps Script Script Properties has API_TOKEN set to this same token, and redeploy the Web App.');
      } else {
        setStatus('Offline', true);
        alert('Network or server error while posting event.');
      }
    }

    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible' && lastLaunch){
        const awayMs = Date.now() - Date.parse(lastLaunch.start);
        if (awayMs > 4*60*1000){
          awardDone('time_away');
        }
      }
    });

    // ====== Init ======
    window.addEventListener('load', async ()=>{
      hydrateTiles();
      await refreshTotals();
    });

    childSelectEl.addEventListener('change', async ()=>{
      hydrateTiles();
      await refreshTotals();
    });
  </script>
</body>
</html>
